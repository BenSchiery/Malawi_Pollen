rm(list = ls())
graphics.off()

library(vegan)

# load the pollen data
poln.full <- read.csv("./data/20200626_pollen.csv")

# load interpolated data generated by code from Malawi_interpolation.R
# choose which interpolation method to use:
## linearly interpolated data:
lake.full <- read.csv("./data/lake_linterp.csv")
char.full <- read.csv("./data/char_linterp.csv")

## Krig interpolated data:
lake.full <- read.csv("./data/lake_Krig.csv")
char.full <- read.csv("./data/char_Krig.csv")

# split the loaded data to mix and match as needed
age <- lake.full[,"age"] # everything should have the same ages
char <- char.full[,"charcoal"]
lake <- lake.full[,"lake"]
poln <- poln.full[,c("Poaceae", "Podocarpus", "miombo", "olea")]
astr <- poln.full[,"asters"]

# a data.frame of data to be used in the vector fit
to.be.fit <- data.frame("age" = age,
                        "charcoal" = char,
                        "lake" = lake,
                        "asters" = astr)

# scale and center the datasets
poln.std <- vegan::decostand(x = poln,
                             method = "chi.square")
to.be.fit.std <- scale(x = to.be.fit)

# make distance matrices
poln.dist <- dist(poln.std, method = "canberra")
to.be.fit.dist <- dist(to.be.fit.std, method = "canberra")

# make the pollen ordination
poln.ord <- cmdscale(d = poln.dist, k = 2, eig = T, add = F, x.ret = F)

# do the vector fit(s) of the data to our ordination
poln.fit <- vegan::envfit(ord = poln.ord,
                          env = poln.std,
                          permutaions = 10000)
add.fit <- vegan::envfit(ord = poln.ord,
                         env = to.be.fit.std,
                         permutaions = 10000)

# plot the results of the vector fits
plot(poln.ord$points, pch = 16)
plot(poln.fit, col = "red")
plot(add.fit, col = "blue")

# ordination surfaces
ordisurf(x = poln.ord, y = age, main = "Age (kyr)")
ordisurf(x = poln.ord, y = char, main = "Charcoal")
ordisurf(x = poln.ord, y = lake, main = "Lake Level")
ordisurf(x = poln.ord, y = astr, main = "Asteraceae")
